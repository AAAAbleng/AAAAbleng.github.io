<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>阅读</title>
        <link rel="stylesheet" href="styles.css">
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>

    <body class="reader-body">
        <div class="nav-bar">
            <div class="nav-container">
                <a href="../index.html" class="nav-btn nav-btn-home">
                    <span class="nav-icon">⌘</span>
                    <span class="nav-text">书架</span>
                </a>
                <button id="toc-btn" class="nav-btn nav-btn-toc">
                    <span class="nav-icon">☰</span>
                    <span class="nav-text">目录</span>
                </button>
                <div id="book-title-nav" class="book-title-nav"></div>
                <button id="settings-btn" class="nav-btn nav-btn-settings">
                    <span class="nav-icon">⚙</span>
                    <span class="nav-text">设置</span>
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="settings-modal" style="display: none;">
            <div class="settings-overlay"></div>
            <div class="settings-dialog">
                <h3>字体大小</h3>
                <div class="font-size-options">
                    <button class="font-size-btn" data-scale="20">20%</button>
                    <button class="font-size-btn" data-scale="35">35%</button>
                    <button class="font-size-btn" data-scale="50">50%</button>
                    <button class="font-size-btn" data-scale="65">65%</button>
                    <button class="font-size-btn" data-scale="80">80%</button>
                    <button class="font-size-btn" data-scale="95">95%</button>
                    <button class="font-size-btn" data-scale="100">100%</button>
                    <button class="font-size-btn" data-scale="110">110%</button>
                    <button class="font-size-btn" data-scale="125">125%</button>
                    <button class="font-size-btn" data-scale="140">140%</button>
                    <button class="font-size-btn" data-scale="155">155%</button>
                    <button class="font-size-btn" data-scale="170">170%</button>
                    <button class="font-size-btn" data-scale="185">185%</button>
                    <button class="font-size-btn" data-scale="200">200%</button>
                </div>
                <div class="settings-actions">
                    <button id="settings-cancel" class="btn btn-secondary">取消</button>
                    <button id="settings-confirm" class="btn btn-primary">确认</button>
                </div>
            </div>
        </div>

        <div class="reader-container">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3>目录</h3>
                    <button id="toggle-sidebar" class="toggle-btn">×</button>
                </div>
                <nav id="sidebar-toc" class="sidebar-toc"></nav>
            </aside>

            <main class="content" id="content">
                <div id="loading" class="loading">加载中...</div>
                <article id="chapter-content" class="chapter-content" style="display: none;"></article>

                <div id="chapter-nav" class="chapter-nav" style="display: none;">
                    <a id="prev-chapter" class="btn btn-nav" style="display: none;">← 上一章</a>
                    <a id="next-chapter" class="btn btn-nav" style="display: none;">下一章 →</a>
                </div>
            </main>
        </div>

        <button id="sidebar-expand-btn" class="sidebar-expand-btn">❯</button>

        <script src="reader.js"></script>
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('book_id');
            const chapterId = urlParams.get('chapter_id');

            let currentMeta = null;
            let currentChapter = null;
            let currentBook = null;

            if (!bookId || !chapterId) {
                document.getElementById('loading').textContent = '错误: 缺少必要参数';
            } else {
                loadChapter(bookId, chapterId);
            }

            async function loadChapter(bookId, chapterId) {
                try {
                    // Load books.json
                    const booksResponse = await fetch('../books.json');
                    const books = await booksResponse.json();
                    currentBook = books.find(b => b.book_id === bookId);

                    if (!currentBook) {
                        throw new Error('未找到该书籍');
                    }

                    // Load meta.json
                    const metaResponse = await fetch('../' + currentBook.meta_path);
                    currentMeta = await metaResponse.json();

                    // Find current chapter
                    currentChapter = currentMeta.chapters.find(ch => ch.chapter_id === chapterId);

                    if (!currentChapter) {
                        throw new Error('未找到该章节');
                    }

                    // Update navigation
                    document.getElementById('book-title-nav').textContent = `${currentMeta.title} - ${currentBook.author}`;
                    document.title = `${currentChapter.title} - ${currentMeta.title}`;

                    // Render sidebar TOC
                    renderSidebarTOC(bookId, chapterId);

                    // Load markdown content
                    const bookDir = currentBook.meta_path.replace('/meta.json', '');
                    const markdownPath = `../${bookDir}/${currentChapter.markdown_file}`;
                    const mdResponse = await fetch(markdownPath);
                    const mdText = await mdResponse.text();

                    // Convert markdown to HTML
                    const html = marked.parse(mdText);

                    // Display content
                    document.getElementById('loading').style.display = 'none';
                    const contentDiv = document.getElementById('chapter-content');
                    contentDiv.innerHTML = html;
                    contentDiv.style.display = 'block';

                    // Fix image paths - make them relative to chapter.html
                    const images = contentDiv.querySelectorAll('img');
                    images.forEach(img => {
                        const src = img.getAttribute('src');
                        if (src && src.startsWith('assets/')) {
                            // Convert assets/image.jpg to ../books_src/{book_id}/assets/image.jpg
                            img.src = `../${bookDir}/${src}`;
                        }
                    });

                    // Apply saved font scale
                    const saved = localStorage.getItem('font_scale');
                    if (saved) {
                        const scale = parseInt(saved);
                        contentDiv.style.fontSize = (scale / 100) + 'em';
                    }

                    // Setup chapter navigation
                    setupChapterNavigation(bookId, chapterId);

                    // Restore scroll position
                    restoreScrollPosition(bookId, chapterId);

                    // Save reading progress
                    saveLastOpenedChapter(bookId, chapterId);

                    // Track scroll position
                    setupScrollTracking(bookId, chapterId);

                } catch (error) {
                    console.error('Error loading chapter:', error);
                    document.getElementById('loading').textContent = '加载失败: ' + error.message;
                }
            }

            function renderSidebarTOC(bookId, currentChapterId) {
                const sidebar = document.getElementById('sidebar-toc');
                sidebar.innerHTML = '';

                currentMeta.chapters.forEach(chapter => {
                    const link = document.createElement('a');
                    link.href = `chapter.html?book_id=${encodeURIComponent(bookId)}&chapter_id=${encodeURIComponent(chapter.chapter_id)}`;
                    link.className = 'toc-item';
                    if (chapter.chapter_id === currentChapterId) {
                        link.classList.add('active');
                    }

                    const number = document.createElement('span');
                    number.className = 'toc-number';
                    number.textContent = chapter.order;

                    const title = document.createElement('span');
                    title.textContent = chapter.title;

                    link.appendChild(number);
                    link.appendChild(title);
                    sidebar.appendChild(link);
                });
            }

            function setupChapterNavigation(bookId, chapterId) {
                const currentIndex = currentMeta.chapters.findIndex(ch => ch.chapter_id === chapterId);
                const navDiv = document.getElementById('chapter-nav');
                const prevBtn = document.getElementById('prev-chapter');
                const nextBtn = document.getElementById('next-chapter');

                navDiv.style.display = 'flex';

                // Previous chapter
                if (currentIndex > 0) {
                    const prevChapter = currentMeta.chapters[currentIndex - 1];
                    prevBtn.href = `chapter.html?book_id=${encodeURIComponent(bookId)}&chapter_id=${encodeURIComponent(prevChapter.chapter_id)}`;
                    prevBtn.style.display = 'inline-block';
                    prevBtn.innerHTML = `← ${prevChapter.title}`;
                }

                // Next chapter
                if (currentIndex < currentMeta.chapters.length - 1) {
                    const nextChapter = currentMeta.chapters[currentIndex + 1];
                    nextBtn.href = `chapter.html?book_id=${encodeURIComponent(bookId)}&chapter_id=${encodeURIComponent(nextChapter.chapter_id)}`;
                    nextBtn.style.display = 'inline-block';
                    nextBtn.innerHTML = `${nextChapter.title} →`;
                }
            }

            function setupScrollTracking(bookId, chapterId) {
                let scrollTimeout;
                window.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        saveScrollPosition(bookId, chapterId, window.scrollY);
                    }, 500);
                });
            }

            // Sidebar toggle logic
            const sidebarExpandBtn = document.getElementById('sidebar-expand-btn');
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggle-sidebar');
            const content = document.getElementById('content');

            // Check if we're on mobile
            function isMobile() {
                return window.innerWidth <= 768;
            }

            // Collapse sidebar with X button (works on both mobile and desktop)
            toggleBtn.addEventListener('click', () => {
                if (isMobile()) {
                    // On mobile, toggle active class for slide-in effect
                    sidebar.classList.remove('active');
                    sidebarExpandBtn.classList.add('visible');
                } else {
                    // On desktop, collapse the sidebar
                    sidebar.classList.toggle('collapsed');
                    sidebarExpandBtn.classList.toggle('visible', sidebar.classList.contains('collapsed'));
                }
            });

            // Expand sidebar with edge button (works on both mobile and desktop)
            sidebarExpandBtn.addEventListener('click', () => {
                if (isMobile()) {
                    sidebar.classList.add('active');
                    sidebarExpandBtn.classList.remove('visible');
                } else {
                    sidebar.classList.remove('collapsed');
                    sidebarExpandBtn.classList.remove('visible');
                }
            });

            // Mobile: Close sidebar when clicking on content area
            content.addEventListener('click', () => {
                if (isMobile() && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    sidebarExpandBtn.classList.add('visible');
                }
            });

            // Handle window resize: reset states when switching between mobile and desktop
            window.addEventListener('resize', () => {
                if (isMobile()) {
                    // Switching to mobile: reset collapsed state, keep expand button visible if sidebar hidden
                    sidebar.classList.remove('collapsed');
                    if (!sidebar.classList.contains('active')) {
                        sidebarExpandBtn.classList.add('visible');
                    }
                } else {
                    // Switching to desktop: hide mobile active state, show sidebar
                    sidebar.classList.remove('active');
                    sidebarExpandBtn.classList.remove('visible');
                }
            });

            // Initialize: on mobile, show expand button since sidebar is hidden by default
            if (isMobile()) {
                sidebarExpandBtn.classList.add('visible');
            }

            // TOC button in nav bar - toggle sidebar
            const tocBtn = document.getElementById('toc-btn');
            tocBtn.addEventListener('click', () => {
                if (isMobile()) {
                    sidebar.classList.toggle('active');
                    sidebarExpandBtn.classList.toggle('visible', !sidebar.classList.contains('active'));
                } else {
                    sidebar.classList.toggle('collapsed');
                    sidebarExpandBtn.classList.toggle('visible', sidebar.classList.contains('collapsed'));
                }
            });

            // Close sidebar when clicking on TOC items on mobile
            document.getElementById('sidebar-toc').addEventListener('click', (e) => {
                if (isMobile() && e.target.closest('.toc-item')) {
                    sidebar.classList.remove('active');
                    sidebarExpandBtn.classList.add('visible');
                }
            });

            // Settings modal logic
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsOverlay = document.querySelector('.settings-overlay');
            const settingsCancelBtn = document.getElementById('settings-cancel');
            const settingsConfirmBtn = document.getElementById('settings-confirm');
            const fontSizeBtns = document.querySelectorAll('.font-size-btn');

            let selectedFontScale = 100; // Default scale

            // Load saved font scale
            function loadFontScale() {
                const saved = localStorage.getItem('font_scale');
                if (saved) {
                    selectedFontScale = parseInt(saved);
                    applyFontScale(selectedFontScale);
                }
                updateFontSizeUI();
            }

            // Apply font scale to content
            function applyFontScale(scale) {
                const contentDiv = document.getElementById('chapter-content');
                if (contentDiv) {
                    contentDiv.style.fontSize = (scale / 100) + 'em';
                }
            }

            // Update UI to show selected size
            function updateFontSizeUI() {
                fontSizeBtns.forEach(btn => {
                    const scale = parseInt(btn.dataset.scale);
                    if (scale === selectedFontScale) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }

            // Open settings modal
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
                updateFontSizeUI();
            });

            // Close settings modal
            function closeSettingsModal() {
                settingsModal.style.display = 'none';
            }

            settingsCancelBtn.addEventListener('click', closeSettingsModal);
            settingsOverlay.addEventListener('click', closeSettingsModal);

            // Select font size (preview)
            fontSizeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const scale = parseInt(btn.dataset.scale);
                    selectedFontScale = scale;
                    updateFontSizeUI();
                    applyFontScale(scale);
                });
            });

            // Confirm settings
            settingsConfirmBtn.addEventListener('click', () => {
                localStorage.setItem('font_scale', selectedFontScale.toString());
                closeSettingsModal();
            });

            // Load font scale on page load
            loadFontScale();
        </script>
    </body>

</html>