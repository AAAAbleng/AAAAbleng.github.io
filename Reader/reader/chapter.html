<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>阅读</title>
        <link rel="stylesheet" href="styles.css">
        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    </head>

    <body class="reader-body">
        <div class="nav-bar">
            <div class="nav-container">
                <a href="../index.html" class="nav-btn nav-btn-home">
                    <span class="nav-icon">⌘</span>
                    <span class="nav-text">书架</span>
                </a>
                <button id="toc-btn" class="nav-btn nav-btn-toc">
                    <span class="nav-icon">☰</span>
                    <span class="nav-text">目录</span>
                </button>
                <div id="book-title-nav" class="book-title-nav"></div>
                <button id="settings-btn" class="nav-btn nav-btn-settings">
                    <span class="nav-icon">⚙</span>
                    <span class="nav-text">设置</span>
                </button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="settings-modal" style="display: none;">
            <div class="settings-overlay"></div>
            <div class="settings-dialog">
                <h3>字体大小</h3>
                <div class="font-size-options">
                    <button class="font-size-btn" data-scale="20">20%</button>
                    <button class="font-size-btn" data-scale="35">35%</button>
                    <button class="font-size-btn" data-scale="50">50%</button>
                    <button class="font-size-btn" data-scale="65">65%</button>
                    <button class="font-size-btn" data-scale="80">80%</button>
                    <button class="font-size-btn" data-scale="95">95%</button>
                    <button class="font-size-btn" data-scale="100">100%</button>
                    <button class="font-size-btn" data-scale="110">110%</button>
                    <button class="font-size-btn" data-scale="125">125%</button>
                    <button class="font-size-btn" data-scale="140">140%</button>
                    <button class="font-size-btn" data-scale="155">155%</button>
                    <button class="font-size-btn" data-scale="170">170%</button>
                    <button class="font-size-btn" data-scale="185">185%</button>
                    <button class="font-size-btn" data-scale="200">200%</button>
                </div>
                <h3 style="margin-top: 20px;">移动端功能</h3>
                <div class="settings-option" id="toolbar-setting-option">
                    <label class="settings-checkbox" id="toolbar-checkbox-label">
                        <input type="checkbox" id="enable-selection-toolbar">
                        <span>启用文字选中工具栏</span>
                    </label>
                    <p class="settings-hint" id="toolbar-hint">选中文字后显示全选、复制、词典查询功能（仅移动设备可用）</p>
                </div>
                <div class="settings-actions">
                    <button id="settings-cancel" class="btn btn-secondary">取消</button>
                    <button id="settings-confirm" class="btn btn-primary">确认</button>
                </div>
            </div>
        </div>

        <div class="reader-container">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3>目录</h3>
                    <button id="toggle-sidebar" class="toggle-btn">×</button>
                </div>
                <nav id="sidebar-toc" class="sidebar-toc"></nav>
            </aside>

            <main class="content" id="content">
                <div id="loading" class="loading">加载中...</div>
                <article id="chapter-content" class="chapter-content" style="display: none;"></article>

                <div id="chapter-nav" class="chapter-nav" style="display: none;">
                    <a id="prev-chapter" class="btn btn-nav" style="display: none;">← 上一章</a>
                    <a id="next-chapter" class="btn btn-nav" style="display: none;">下一章 →</a>
                </div>
            </main>
        </div>

        <button id="sidebar-expand-btn" class="sidebar-expand-btn">❯</button>

        <!-- Text Selection Toolbar for Mobile -->
        <div id="selection-toolbar" class="selection-toolbar" style="display: none;">
            <button id="select-all-btn" class="toolbar-btn" title="全选">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" />
                    <path d="M9 11l3 3 5-5" />
                </svg>
            </button>
            <button id="copy-btn" class="toolbar-btn" title="复制">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
                </svg>
            </button>
            <button id="dict-btn" class="toolbar-btn" title="词典查询">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8" />
                    <path d="M21 21l-4.35-4.35" />
                    <path d="M11 8v6" />
                    <path d="M8 11h6" />
                </svg>
            </button>
        </div>

        <script src="reader.js"></script>
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('book_id');
            const chapterId = urlParams.get('chapter_id');

            let currentMeta = null;
            let currentChapter = null;
            let currentBook = null;

            if (!bookId || !chapterId) {
                document.getElementById('loading').textContent = '错误: 缺少必要参数';
            } else {
                loadChapter(bookId, chapterId);
            }

            async function loadChapter(bookId, chapterId) {
                try {
                    // Load books.json
                    const booksResponse = await fetch('../books.json');
                    const books = await booksResponse.json();
                    currentBook = books.find(b => b.book_id === bookId);

                    if (!currentBook) {
                        throw new Error('未找到该书籍');
                    }

                    // Load meta.json
                    const metaResponse = await fetch('../' + currentBook.meta_path);
                    currentMeta = await metaResponse.json();

                    // Find current chapter
                    currentChapter = currentMeta.chapters.find(ch => ch.chapter_id === chapterId);

                    if (!currentChapter) {
                        throw new Error('未找到该章节');
                    }

                    // Update navigation
                    document.getElementById('book-title-nav').textContent = `${currentMeta.title} - ${currentBook.author}`;
                    document.title = `${currentChapter.title} - ${currentMeta.title}`;

                    // Render sidebar TOC
                    renderSidebarTOC(bookId, chapterId);

                    // Load markdown content
                    const bookDir = currentBook.meta_path.replace('/meta.json', '');
                    const markdownPath = `../${bookDir}/${currentChapter.markdown_file}`;
                    const mdResponse = await fetch(markdownPath);
                    const mdText = await mdResponse.text();

                    // Convert markdown to HTML
                    const html = marked.parse(mdText);

                    // Display content
                    document.getElementById('loading').style.display = 'none';
                    const contentDiv = document.getElementById('chapter-content');
                    contentDiv.innerHTML = html;
                    contentDiv.style.display = 'block';

                    // Fix image paths - make them relative to chapter.html
                    const images = contentDiv.querySelectorAll('img');
                    images.forEach(img => {
                        const src = img.getAttribute('src');
                        if (src && src.startsWith('assets/')) {
                            // Convert assets/image.jpg to ../books_src/{book_id}/assets/image.jpg
                            img.src = `../${bookDir}/${src}`;
                        }
                    });

                    // Apply saved font scale
                    const saved = localStorage.getItem('font_scale');
                    if (saved) {
                        const scale = parseInt(saved);
                        contentDiv.style.fontSize = (scale / 100) + 'em';
                    }

                    // Setup chapter navigation
                    setupChapterNavigation(bookId, chapterId);

                    // Restore scroll position
                    restoreScrollPosition(bookId, chapterId);

                    // Save reading progress
                    saveLastOpenedChapter(bookId, chapterId);

                    // Track scroll position
                    setupScrollTracking(bookId, chapterId);

                } catch (error) {
                    console.error('Error loading chapter:', error);
                    document.getElementById('loading').textContent = '加载失败: ' + error.message;
                }
            }

            function renderSidebarTOC(bookId, currentChapterId) {
                const sidebar = document.getElementById('sidebar-toc');
                sidebar.innerHTML = '';

                currentMeta.chapters.forEach(chapter => {
                    const link = document.createElement('a');
                    link.href = `chapter.html?book_id=${encodeURIComponent(bookId)}&chapter_id=${encodeURIComponent(chapter.chapter_id)}`;
                    link.className = 'toc-item';
                    if (chapter.chapter_id === currentChapterId) {
                        link.classList.add('active');
                    }

                    const number = document.createElement('span');
                    number.className = 'toc-number';
                    number.textContent = chapter.order;

                    const title = document.createElement('span');
                    title.textContent = chapter.title;

                    link.appendChild(number);
                    link.appendChild(title);
                    sidebar.appendChild(link);
                });
            }

            function setupChapterNavigation(bookId, chapterId) {
                const currentIndex = currentMeta.chapters.findIndex(ch => ch.chapter_id === chapterId);
                const navDiv = document.getElementById('chapter-nav');
                const prevBtn = document.getElementById('prev-chapter');
                const nextBtn = document.getElementById('next-chapter');

                navDiv.style.display = 'flex';

                // Previous chapter
                if (currentIndex > 0) {
                    const prevChapter = currentMeta.chapters[currentIndex - 1];
                    prevBtn.href = `chapter.html?book_id=${encodeURIComponent(bookId)}&chapter_id=${encodeURIComponent(prevChapter.chapter_id)}`;
                    prevBtn.style.display = 'inline-block';
                    prevBtn.innerHTML = `← ${prevChapter.title}`;
                }

                // Next chapter
                if (currentIndex < currentMeta.chapters.length - 1) {
                    const nextChapter = currentMeta.chapters[currentIndex + 1];
                    nextBtn.href = `chapter.html?book_id=${encodeURIComponent(bookId)}&chapter_id=${encodeURIComponent(nextChapter.chapter_id)}`;
                    nextBtn.style.display = 'inline-block';
                    nextBtn.innerHTML = `${nextChapter.title} →`;
                }
            }

            function setupScrollTracking(bookId, chapterId) {
                let scrollTimeout;
                window.addEventListener('scroll', () => {
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        saveScrollPosition(bookId, chapterId, window.scrollY);
                    }, 500);
                });
            }

            // Sidebar toggle logic
            const sidebarExpandBtn = document.getElementById('sidebar-expand-btn');
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggle-sidebar');
            const content = document.getElementById('content');

            // Check if we're on mobile
            function isMobile() {
                return window.innerWidth <= 768;
            }

            // Collapse sidebar with X button (works on both mobile and desktop)
            toggleBtn.addEventListener('click', () => {
                if (isMobile()) {
                    // On mobile, toggle active class for slide-in effect
                    sidebar.classList.remove('active');
                    sidebarExpandBtn.classList.add('visible');
                } else {
                    // On desktop, collapse the sidebar
                    sidebar.classList.toggle('collapsed');
                    sidebarExpandBtn.classList.toggle('visible', sidebar.classList.contains('collapsed'));
                }
            });

            // Expand sidebar with edge button (works on both mobile and desktop)
            sidebarExpandBtn.addEventListener('click', () => {
                if (isMobile()) {
                    sidebar.classList.add('active');
                    sidebarExpandBtn.classList.remove('visible');
                } else {
                    sidebar.classList.remove('collapsed');
                    sidebarExpandBtn.classList.remove('visible');
                }
            });

            // Mobile: Close sidebar when clicking on content area
            content.addEventListener('click', () => {
                if (isMobile() && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    sidebarExpandBtn.classList.add('visible');
                }
            });

            // Handle window resize: reset states when switching between mobile and desktop
            window.addEventListener('resize', () => {
                if (isMobile()) {
                    // Switching to mobile: reset collapsed state, keep expand button visible if sidebar hidden
                    sidebar.classList.remove('collapsed');
                    if (!sidebar.classList.contains('active')) {
                        sidebarExpandBtn.classList.add('visible');
                    }
                } else {
                    // Switching to desktop: hide mobile active state, show sidebar
                    sidebar.classList.remove('active');
                    sidebarExpandBtn.classList.remove('visible');
                }
            });

            // Initialize: on mobile, show expand button since sidebar is hidden by default
            if (isMobile()) {
                sidebarExpandBtn.classList.add('visible');
            }

            // TOC button in nav bar - toggle sidebar
            const tocBtn = document.getElementById('toc-btn');
            tocBtn.addEventListener('click', () => {
                if (isMobile()) {
                    sidebar.classList.toggle('active');
                    sidebarExpandBtn.classList.toggle('visible', !sidebar.classList.contains('active'));
                } else {
                    sidebar.classList.toggle('collapsed');
                    sidebarExpandBtn.classList.toggle('visible', sidebar.classList.contains('collapsed'));
                }
            });

            // Close sidebar when clicking on TOC items on mobile
            document.getElementById('sidebar-toc').addEventListener('click', (e) => {
                if (isMobile() && e.target.closest('.toc-item')) {
                    sidebar.classList.remove('active');
                    sidebarExpandBtn.classList.add('visible');
                }
            });

            // Settings modal logic
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const settingsOverlay = document.querySelector('.settings-overlay');
            const settingsCancelBtn = document.getElementById('settings-cancel');
            const settingsConfirmBtn = document.getElementById('settings-confirm');
            const fontSizeBtns = document.querySelectorAll('.font-size-btn');

            let selectedFontScale = 100; // Default scale

            // Load saved font scale
            function loadFontScale() {
                const saved = localStorage.getItem('font_scale');
                if (saved) {
                    selectedFontScale = parseInt(saved);
                    applyFontScale(selectedFontScale);
                }
                updateFontSizeUI();
            }

            // Apply font scale to content
            function applyFontScale(scale) {
                const contentDiv = document.getElementById('chapter-content');
                if (contentDiv) {
                    contentDiv.style.fontSize = (scale / 100) + 'em';
                }
            }

            // Update UI to show selected size
            function updateFontSizeUI() {
                fontSizeBtns.forEach(btn => {
                    const scale = parseInt(btn.dataset.scale);
                    if (scale === selectedFontScale) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            }

            // Open settings modal
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
                updateFontSizeUI();
            });

            // Close settings modal
            function closeSettingsModal() {
                settingsModal.style.display = 'none';
            }

            settingsCancelBtn.addEventListener('click', closeSettingsModal);
            settingsOverlay.addEventListener('click', closeSettingsModal);

            // Select font size (preview)
            fontSizeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const scale = parseInt(btn.dataset.scale);
                    selectedFontScale = scale;
                    updateFontSizeUI();
                    applyFontScale(scale);
                });
            });

            // Confirm settings
            settingsConfirmBtn.addEventListener('click', () => {
                localStorage.setItem('font_scale', selectedFontScale.toString());
                closeSettingsModal();
            });

            // Load font scale on page load
            loadFontScale();

            // ============ Text Selection Toolbar Logic ============
            const selectionToolbar = document.getElementById('selection-toolbar');
            const selectAllBtn = document.getElementById('select-all-btn');
            const copyBtn = document.getElementById('copy-btn');
            const dictBtn = document.getElementById('dict-btn');
            let toolbarEnabled = true;

            // Check if device is mobile (including tablets)
            function isMobileDevice() {
                return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                    (navigator.maxTouchPoints && navigator.maxTouchPoints > 2);
            }

            // Disable default context menu on mobile when toolbar is enabled
            function setupMobileContextMenuBlock() {
                const chapterContent = document.getElementById('chapter-content');
                if (!chapterContent) return;

                // Block default context menu (long press menu)
                chapterContent.addEventListener('contextmenu', (e) => {
                    if (isMobileDevice() && toolbarEnabled) {
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                });

                // Prevent default selection UI on touch devices
                chapterContent.style.webkitUserSelect = 'text';
                chapterContent.style.userSelect = 'text';

                // Handle touch selection - show our toolbar instead of native
                let touchStartTime = 0;
                let touchStartPos = { x: 0, y: 0 };

                chapterContent.addEventListener('touchstart', (e) => {
                    touchStartTime = Date.now();
                    touchStartPos = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }, { passive: true });

                chapterContent.addEventListener('touchend', (e) => {
                    if (!isMobileDevice() || !toolbarEnabled) return;

                    const touchDuration = Date.now() - touchStartTime;

                    // Long press detection (> 500ms)
                    if (touchDuration > 500) {
                        setTimeout(() => {
                            const selection = window.getSelection();
                            if (selection && selection.toString().trim().length > 0) {
                                showSelectionToolbar();
                            }
                        }, 100);
                    }
                }, { passive: true });
            }

            // Load toolbar enabled state
            function loadToolbarState() {
                const checkbox = document.getElementById('enable-selection-toolbar');
                const checkboxLabel = document.getElementById('toolbar-checkbox-label');
                const toolbarHint = document.getElementById('toolbar-hint');
                const toolbarOption = document.getElementById('toolbar-setting-option');
                const isMobile = isMobileDevice();

                if (!isMobile) {
                    // Desktop: disable checkbox, uncheck it, gray out everything
                    toolbarEnabled = false;
                    checkbox.checked = false;
                    checkbox.disabled = true;
                    checkboxLabel.classList.add('disabled');
                    toolbarOption.classList.add('disabled');
                } else {
                    // Mobile: enable checkbox, load saved state (default true)
                    checkbox.disabled = false;
                    checkboxLabel.classList.remove('disabled');
                    toolbarOption.classList.remove('disabled');

                    const saved = localStorage.getItem('selection_toolbar_enabled');
                    if (saved !== null) {
                        toolbarEnabled = saved === 'true';
                    } else {
                        toolbarEnabled = true; // Default enabled for mobile
                    }
                    checkbox.checked = toolbarEnabled;

                    // Setup context menu blocking for mobile
                    setupMobileContextMenuBlock();
                }
            }

            // Save toolbar enabled state
            function saveToolbarState() {
                localStorage.setItem('selection_toolbar_enabled', toolbarEnabled.toString());
            }

            // Handle settings checkbox change
            document.getElementById('enable-selection-toolbar').addEventListener('change', (e) => {
                toolbarEnabled = e.target.checked;
            });

            // Save toolbar state when confirming settings
            const originalConfirmHandler = settingsConfirmBtn.onclick;
            settingsConfirmBtn.addEventListener('click', () => {
                saveToolbarState();
            });

            // Show selection toolbar at selected text position
            function showSelectionToolbar() {
                if (!isMobileDevice() || !toolbarEnabled) return;

                const selection = window.getSelection();
                if (!selection || selection.rangeCount === 0) return;

                const selectedText = selection.toString().trim();
                if (selectedText.length === 0) {
                    hideSelectionToolbar();
                    return;
                }

                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();

                // Position toolbar above selected text
                const toolbarWidth = 160; // Approximate width
                const toolbarHeight = 50;

                let left = rect.left + (rect.width / 2) - (toolbarWidth / 2);
                let top = rect.top - toolbarHeight - 10;

                // Keep toolbar within viewport
                const padding = 10;
                if (left < padding) left = padding;
                if (left + toolbarWidth > window.innerWidth - padding) {
                    left = window.innerWidth - toolbarWidth - padding;
                }

                // If not enough space above, show below
                if (top < padding) {
                    top = rect.bottom + 10;
                }

                selectionToolbar.style.left = `${left + window.scrollX}px`;
                selectionToolbar.style.top = `${top + window.scrollY}px`;
                selectionToolbar.style.display = 'flex';
            }

            // Hide selection toolbar
            function hideSelectionToolbar() {
                selectionToolbar.style.display = 'none';
            }

            // Handle text selection
            let selectionTimeout;
            document.addEventListener('selectionchange', () => {
                clearTimeout(selectionTimeout);
                selectionTimeout = setTimeout(() => {
                    const selection = window.getSelection();
                    if (selection && selection.toString().trim().length > 0) {
                        showSelectionToolbar();
                    } else {
                        hideSelectionToolbar();
                    }
                }, 100);
            });

            // Hide toolbar when clicking outside
            document.addEventListener('click', (e) => {
                if (!selectionToolbar.contains(e.target)) {
                    // Delay to allow button clicks to register
                    setTimeout(() => {
                        const selection = window.getSelection();
                        if (!selection || selection.toString().trim().length === 0) {
                            hideSelectionToolbar();
                        }
                    }, 100);
                }
            });

            // Hide toolbar on scroll
            let scrollHideTimeout;
            window.addEventListener('scroll', () => {
                if (selectionToolbar.style.display !== 'none') {
                    clearTimeout(scrollHideTimeout);
                    scrollHideTimeout = setTimeout(() => {
                        hideSelectionToolbar();
                    }, 100);
                }
            });

            // Select All button
            selectAllBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const contentDiv = document.getElementById('chapter-content');
                if (contentDiv) {
                    const range = document.createRange();
                    range.selectNodeContents(contentDiv);
                    const selection = window.getSelection();
                    selection.removeAllRanges();
                    selection.addRange(range);

                    // Reposition toolbar after selection change
                    setTimeout(() => showSelectionToolbar(), 50);
                }
            });

            // Copy button
            copyBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                e.stopPropagation();

                const selection = window.getSelection();
                const text = selection.toString();

                let copySuccess = false;

                // 方法1: 尝试使用现代 Clipboard API
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    try {
                        await navigator.clipboard.writeText(text);
                        copySuccess = true;
                    } catch (err) {
                        console.log('Clipboard API failed, trying fallback:', err);
                    }
                }

                // 方法2: 备选方案 - 使用 execCommand
                if (!copySuccess) {
                    try {
                        // 创建临时 textarea
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed';
                        textarea.style.left = '-9999px';
                        textarea.style.top = '0';
                        document.body.appendChild(textarea);
                        textarea.focus();
                        textarea.select();

                        copySuccess = document.execCommand('copy');
                        document.body.removeChild(textarea);

                        // 恢复原来的选择
                        if (selection.rangeCount > 0) {
                            selection.removeAllRanges();
                        }
                    } catch (err) {
                        console.error('execCommand copy failed:', err);
                    }
                }

                if (copySuccess) {
                    // Visual feedback - 显示成功图标
                    const originalHTML = copyBtn.innerHTML;
                    copyBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#48bb78" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';

                    setTimeout(() => {
                        copyBtn.innerHTML = originalHTML;
                        hideSelectionToolbar();
                    }, 1000);
                } else {
                    alert('复制失败，请手动复制');
                }
            });

            // Dictionary button - Eudic lookup
            dictBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const selection = window.getSelection();
                const text = selection.toString().trim();

                if (text.length === 0) return;

                const word = encodeURIComponent(text);

                // 欧路词典 URL Scheme - 使用 peek 模式
                const eudicUrl = `eudic://peek/${word}`;

                // 直接打开欧路词典
                window.location.href = eudicUrl;

                // Hide toolbar after action
                setTimeout(() => {
                    hideSelectionToolbar();
                }, 800);
            });

            // Initialize toolbar state
            loadToolbarState();
        </script>
    </body>

</html>