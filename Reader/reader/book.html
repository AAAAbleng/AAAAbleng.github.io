<!DOCTYPE html>
<html lang="zh-CN">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>目录</title>
        <link rel="stylesheet" href="styles.css">
    </head>

    <body>
        <div class="nav-bar">
            <div class="nav-container">
                <a href="../index.html" class="nav-link">← 返回书架</a>
                <div id="book-title-nav" class="book-title-nav"></div>
            </div>
        </div>

        <div class="container">
            <div class="toc-container">
                <div id="loading" class="loading">加载中...</div>

                <div id="book-info" style="display: none;">
                    <h1 id="book-title" class="book-title-main"></h1>
                    <p id="book-author" class="book-author-main"></p>

                    <div id="continue-reading" style="display: none; margin: 20px 0;">
                        <a id="continue-btn" class="btn btn-continue">继续阅读</a>
                    </div>

                    <h2 class="toc-heading">目录</h2>
                    <div id="chapters-list" class="chapters-list"></div>
                </div>
            </div>
        </div>

        <script src="reader.js"></script>
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get('book_id');

            if (!bookId) {
                document.getElementById('loading').textContent = '错误: 未指定书籍 ID';
            } else {
                loadBookTOC(bookId);
            }

            async function loadBookTOC(bookId) {
                try {
                    // Load books.json to get meta_path
                    const booksResponse = await fetch('../books.json');
                    const books = await booksResponse.json();
                    const book = books.find(b => b.book_id === bookId);

                    if (!book) {
                        throw new Error('未找到该书籍');
                    }

                    // Load meta.json
                    const metaResponse = await fetch('../' + book.meta_path);
                    const meta = await metaResponse.json();

                    // Update page
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('book-info').style.display = 'block';

                    document.getElementById('book-title').textContent = meta.title;
                    document.getElementById('book-title-nav').textContent = meta.title;
                    document.getElementById('book-author').textContent = '作者: ' + meta.author;
                    document.title = meta.title + ' - 目录';

                    // Check for last opened chapter
                    const lastChapterData = getLastOpenedChapter(bookId);
                    if (lastChapterData) {
                        const continueSection = document.getElementById('continue-reading');
                        const continueBtn = document.getElementById('continue-btn');

                        const chapter = meta.chapters.find(ch => ch.chapter_id === lastChapterData.chapter_id);
                        if (chapter) {
                            continueBtn.textContent = `继续阅读: ${chapter.title}`;
                            continueBtn.href = `chapter.html?book_id=${encodeURIComponent(bookId)}&chapter_id=${encodeURIComponent(lastChapterData.chapter_id)}`;
                            continueSection.style.display = 'block';
                        }
                    }

                    // Render chapters
                    const chaptersList = document.getElementById('chapters-list');
                    meta.chapters.forEach(chapter => {
                        const chapterItem = document.createElement('a');
                        chapterItem.href = `chapter.html?book_id=${encodeURIComponent(bookId)}&chapter_id=${encodeURIComponent(chapter.chapter_id)}`;
                        chapterItem.className = 'chapter-item';

                        const chapterNumber = document.createElement('span');
                        chapterNumber.className = 'chapter-number';
                        chapterNumber.textContent = chapter.order;

                        const chapterTitle = document.createElement('span');
                        chapterTitle.className = 'chapter-title';
                        chapterTitle.textContent = chapter.title;

                        chapterItem.appendChild(chapterNumber);
                        chapterItem.appendChild(chapterTitle);
                        chaptersList.appendChild(chapterItem);
                    });

                } catch (error) {
                    console.error('Error loading book TOC:', error);
                    document.getElementById('loading').textContent = '加载失败: ' + error.message;
                }
            }
        </script>
    </body>

</html>